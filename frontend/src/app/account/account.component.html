<section class="hero is-halfheight mt-6 " style="min-height: 70vh;">
    <div class="container is-fluid ">
        <div>
            <h1 class="is-size-1 has-text-centered has-text-weight-bold has-text-info pt-6"
                style="line-height: normal;">Edit your account ⚙️
            </h1>


            <div class="is-flex columns is-centered mt-4">
                <div class="column  is-four-fifths-desktop">

                    <div class="form-container">
                        <h1 class="has-text-info has-text-weight-bold is-size-3">
                            Change username
                        </h1>
                        <div style="border-bottom: 1px solid silver"></div>
                        <p class="has-text-grey pb-3">Your current username is:</p>
                        <label class="label">New username</label>
                        <div class="field is-flex-tablet">
                            <div class="control has-icons-left mb-3">
                                <input class="input" type="text" placeholder="Username" name="username" [(ngModel)]="username" (keyup)="checkUsername()" [ngClass]="{'is-danger' : usernameErrorMessage != ''}">
                                <span class="help has-text-left is-danger" *ngIf="usernameErrorMessage != ''">{{usernameErrorMessage}}</span>
                                <span class="icon is-small is-left">
                                    <fa-icon [icon]="faUser"></fa-icon>
                                </span>
                            </div>
                            <div class="has-text-centered">
                                <button class="button is-info is-outlined is-centered ml-3">Change</button>
                            </div>
                        </div>
                    </div>



                    <div class="mt-6">
                        <h1 class="has-text-info has-text-weight-bold is-size-3">
                            Update email
                        </h1>
                        <div style="border-bottom: 1px solid silver"></div>
                        <p class="has-text-grey pb-3">Your current email is : {{userService.getEmail()}}</p>
                        <label class="label">New email</label>
                        <div class="field is-flex-tablet">
                            <div class="control has-icons-left">
                                <input class="input" type="email" placeholder="Email" name="email" [(ngModel)]="email" (keyup)="checkEmail()" [ngClass]="{'is-danger' : emailErrorMessage != '' || emailConfirmErrorMessage != ''}">
                                <span class="help has-text-left is-danger" *ngIf="emailErrorMessage != ''">{{emailErrorMessage}}</span>
                                <span class="icon is-small is-left">
                                    <fa-icon [icon]="faEnvelope"></fa-icon>
                                </span>
                            </div>
                        </div>
                        <div class="field is-flex-tablet">
                            <div class="control has-icons-left mb-3">
                                <input class="input" type="email" placeholder="Confirm email" name="confirmEmail" [(ngModel)]="confirmEmail" (keyup)="checkEmail()" [ngClass]="{'is-danger' : emailConfirmErrorMessage != ''}">
                                <span class="help has-text-left is-danger" *ngIf="emailConfirmErrorMessage != ''">{{emailConfirmErrorMessage}}</span>
                                <span class="icon is-small is-left">
                                    <fa-icon [icon]="faEnvelope"></fa-icon>
                                </span>
                            </div>
                            <div class="has-text-centered">
                                <button class="button is-info is-outlined ml-3" (click)="updateEmail()" [ngClass]="{'is-loading': this.buttonLoading['email']}">Update</button>
                            </div>
                        </div>
                    </div>



                    <div class="mt-6">
                        <h1 class="has-text-info has-text-weight-bold is-size-3">
                            Update passphrase
                        </h1>
                        <div style="border-bottom: 1px solid silver"></div>
                        <label class="label mt-3">Your current passphrase</label>
                        <div class="field is-flex-tablet">
                            <div class="control has-icons-left">
                                <input class="input" type="password" placeholder="Passphrase" name="password" [(ngModel)]="password">
                                <span class="icon is-small is-left">
                                    <fa-icon [icon]="faLock"></fa-icon>
                                </span>
                            </div>
                        </div>
                        <label class="label mt-3">New passphrase</label>
                        <div class="field is-flex-tablet">
                            <div class="control has-icons-left">
                                <input class="input" type="password" placeholder="New passphrase" name="newPassword" [(ngModel)]="newPassword"(keyup)="checkNewPassword()" [ngClass]="{'is-danger' : newPasswordErrorMessage.length >1 || newPasswordConfirmErrorMessage.length >1 }">
                                <span class="help has-text-left is-danger" *ngIf="newPasswordErrorMessage.length >1">
                                    <span *ngFor="let error of newPasswordErrorMessage" >
                                        <span *ngIf="error!=''">{{error}}<br></span>
                                    </span>
                                </span>
                                <span class="icon is-small is-left">
                                    <fa-icon [icon]="faLock"></fa-icon>
                                </span>
                            </div>
                        </div>
                        <div class="field is-flex-tablet">
                            <div class="control has-icons-left mb-3">
                                <input class="input" type="password" placeholder="Confirm Passphrase" name="confirmNewPassword" [(ngModel)]="confirmNewPassword" [ngClass]="{'is-danger' : newPasswordConfirmErrorMessage.length >1}" (keyup)="checkNewPassword()">
                               <span class="help has-text-left is-danger" *ngIf="newPasswordConfirmErrorMessage.length >1">
                                    <span *ngFor="let error of newPasswordConfirmErrorMessage" >
                                        <span *ngIf="error!=''">{{error}}<br></span>
                                    </span>
                                </span> 
                                <span class="icon is-small is-left">
                                    <fa-icon [icon]="faLock"></fa-icon>
                                </span>
                            </div>
                            <div class="has-text-centered">
                                <button class="button is-info is-outlined ml-3" (click)="updatePassphrase()">Update</button>
                            </div>
                        </div>
                    </div>



                    <div class="mt-6">
                        <h1 class="has-text-danger has-text-weight-bold is-size-3">
                            Delete account
                        </h1>
                        <div style="border-bottom: 1px solid silver"></div>
                        <p class="has-text-grey pb-3">Once you delete your account, there is no going
                            back. Please be certain.</p>
                        <div class="control">
                            <button class="button is-danger is-outlined" (click)="deletionModal()"
                                data-target="confirmation">Delete
                                your account</button>
                        </div>
                    </div>

                    

                </div>
            </div>
        </div>
    </div>
</section>
<div id="confirmation" class="modal modal-fx-fadeInScale" [ngClass]="{'is-active': isDeletionModalActive}">
    <div class="modal-background" (click)="deletionModal()"></div>
    <div class="modal-content">
        <section class="modal-card-body">
            <h1 class="is-size-1 has-text-danger">Are you sure ?</h1>
            <strong>You won't be able to undo this action. You will no longer access to your TOTP vault</strong>.<br><br>
        </section>
        <footer class="modal-card-foot is-flex is-justify-content-right">
            <button class="button" (click)="deletionModal()" [disabled]="buttonLoading['passphrase']">Cancel</button>
            <button class="button is-danger" (click)="deleteAccount()" [ngClass]="{'is-loading': buttonLoading['deletion']}">Destroy my account definitely</button>
        </footer>
    </div>
    <button class="modal-close is-large" aria-label="close" (click)="deletionModal()" *ngIf="!buttonLoading['deletion']"></button>
</div>


<div id="passphraseConfirmation" class="modal modal-fx-fadeInScale" [ngClass]="{'is-active': isPassphraseModalActive}">
    <div class="modal-background" (click)="passphraseModal()"></div>
    <div class="modal-content">
        <section class="modal-card-body">
            <h1 class="is-size-1 has-text-info">Be careful </h1>
            <div class="content">
            <strong>Changing your passphrase will :</strong> 
            <ul>
                <li>Re-encrypt your current vault</li>
                <li>Your old backup will still be encrypted with your former passphrase</li>
                <li>Your Google Drive backup will be updated. If you have old backup, they will still be encrypted with your former passphrase. If your passphrase is not safe anymore you should delete them without delay</li>
                <li>If you lose this new passphrase, it is impossible to recover it</li>
                <li>If you change your passphrase for security reasons, securely delete your backup as soon as possible </li>
            </ul>
        </div>
        </section>
        <footer class="modal-card-foot is-flex is-justify-content-right">
            <button class="button" (click)="passphraseModal()" [disabled]="buttonLoading['passphrase']">Cancel</button>
            <button class="button is-info" (click)="updatePassphraseConfirm()" [ngClass]="{'is-loading': buttonLoading['passphrase']}">I'm sure</button>
        </footer>
    </div>
    <button class="modal-close is-large" aria-label="close" (click)="passphraseModal()" *ngIf="!buttonLoading['passphrase']"></button>
</div>
<div id="passphraseUpdate" class="modal modal-fx-fadeInScale" [ngClass]="{'is-active': buttonLoading['passphrase']}">
    <div class="modal-background"></div>
    <div class="modal-content">
        <section class="modal-card-body">
            <h1 class="is-size-1 has-text-danger">Do not close this page</h1>
            <strong>We are re encrypting all your data. Closing this tab might definitively corrupt them</strong> <br><br>
            <progress class="progress is-small is-success" max="100"></progress>
            <p class="">
                <fa-icon [icon]="faCheck" class="has-text-success" *ngIf="stepsDone.includes('verifyOldPassword')" class="has-text-success"></fa-icon > 
                <fa-icon [icon]="faCog" [spin]="true" *ngIf="!stepsDone.includes('verifyOldPassword')"></fa-icon > 
                <span [ngClass]="{'has-text-success': stepsDone.includes('verifyOldPassword')}"> Verification of your former passphrase</span><br>

                <fa-icon [icon]="faCheck" class="has-text-success" *ngIf="stepsDone.includes('getVault')"></fa-icon > 
                <fa-icon *ngIf="!stepsDone.includes('getVault')" [icon]="faCog" [spin]="true" ></fa-icon> 
                <span [ngClass]="{'has-text-success': stepsDone.includes('getVault')}"> Download of your encrypted vault</span><br>

                <fa-icon [icon]="faCheck" class="has-text-success" *ngIf="stepsDone.includes('getVault')"></fa-icon > 
                <fa-icon *ngIf="!stepsDone.includes('getVault')" [icon]="faCog" [spin]="true"></fa-icon > 
                    <span [ngClass]="{'has-text-success': stepsDone.includes('getVault')}"> Decryption of your vault</span><br>

                <fa-icon [icon]="faCheck" class="has-text-success" *ngIf="stepsDone.includes('derivation')"></fa-icon > 
                <fa-icon *ngIf="!stepsDone.includes('derivation')" [icon]="faCog" [spin]="true"></fa-icon > 
                <span [ngClass]="{'has-text-success': stepsDone.includes('derivation')}"> Derivation of your new passphrase</span><br>

                <fa-icon [icon]="faCheck" class="has-text-success" *ngIf="stepsDone.includes('encryption')"></fa-icon > 
                <fa-icon *ngIf="!stepsDone.includes('encryption')" [icon]="faCog" [spin]="true"></fa-icon > 
                <span [ngClass]="{'has-text-success': stepsDone.includes('encryption')}"> Encryption of your vault with your new key</span><br>

                <fa-icon [icon]="faCheck" class="has-text-success" *ngIf="stepsDone.includes('verification')"></fa-icon > 
                <fa-icon [icon]="faCog" [spin]="true"  *ngIf="!stepsDone.includes('verification')"></fa-icon> 
                <span [ngClass]="{'has-text-success': stepsDone.includes('verification')}"> Verification of your new encrypted vault</span><br>

                <fa-icon [icon]="faCheck" class="has-text-success" *ngIf="stepsDone.includes('upload')"></fa-icon > 
                <fa-icon [icon]="faCog" [spin]="true" *ngIf="!stepsDone.includes('upload')"></fa-icon > 
                <span [ngClass]="{'has-text-success': stepsDone.includes('upload')}"> Upload of your encrypted vault</span><br>

                <fa-icon [icon]="faCheck" class="has-text-success" *ngIf="stepsDone.includes('deleteBackup')"></fa-icon > 
                    <fa-icon [icon]="faCog" [spin]="true" *ngIf="!stepsDone.includes('deleteBackup')"></fa-icon > 
                    <span [ngClass]="{'has-text-success': stepsDone.includes('deleteBackup')}"> Destroy of your google drive backup  </span><br>
                
                
            </p>

        </section>
    </div>
</div>


<div id="passphraseConfirmation" class="modal modal-fx-fadeInScale" [ngClass]="{'is-active': isPassphraseModalActive}">
    <div class="modal-background" (click)="passphraseModal()"></div>
    <div class="modal-content">
        <section class="modal-card-body">
            <h1 class="is-size-1 has-text-info">Oh ! You have backups in your google drive</h1>
            <div class="content">
            <strong></strong> 

            
        </div>
        </section>
        <footer class="modal-card-foot is-flex is-justify-content-right">
            <button class="button" (click)="googleDriveBackupModaleActive = false; isPassphraseModalActive=false; isDeletionModalActive=false;" >Abort</button>
            <button class="button is-info" (click)=" googleDriveBackupModaleActive=false; updatePassphraseConfirm()" [disabled]="deleteGoogleDriveBackup == undefined">Continue</button>
        </footer>
    </div>